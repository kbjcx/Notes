---
aliases: [硬中断, 软中断]
area: 操作系统
project: 
date: 2023-04-10 21:12
---
---
# Description
> [!quote]
> 中断是指计算机运行过程中, 出现某些意外情况需要主机干预时, 能自动停止正在运行的程序转而处理新情况的程序, 处理完毕后又转回原程序继续运行

## 中断的作用
1. **外设异步通知 CPU**
     外设发生了什么事情或者完成了什么任务或者有什么消息要告诉 CPU，都可以异步给 CPU 发通知。例如，网卡收到了网络包，磁盘完成了 IO 任务，定时器的间隔时间到了，都可以给 CPU 发中断信号
 1. **CPU 之间发送消息**
     在 SMP (对称多处理器) 系统中，一个 CPU 想要给另一个 CPU 发送消息，可以给其发送 IPI (处理器间中断)
 1. **处理 CPU 异常**
    CPU 在执行指令的过程中遇到了异常会给自己发送中断信号来处理异常。例如，做整数除法运算的时候发现被除数是 0，访问虚拟内存的时候发现虚拟内存没有映射到物理内存上
1. **实现系统调用**
    早期的系统调用就是靠中断指令来实现的，后期虽然开发了专用的系统调用指令，但是其基本原理还是相似的

## 中断的处理
**执行场景**

在中断产生之前是没有这个概念的，有了中断之后，CPU 就分为两个执行场景了，*进程执行场景 (process context)* 和 *中断执行场景 (interrupt context)*

==进程的执行是进程执行场景，同步中断的处理也是进程执行场景，异步中断的处理是中断执行场景==

**进程执行场景和中断执行场景有两个区别：**
1. 进程执行场景是可以调度、可以休眠的，而中断执行场景是不可以调度不可用休眠的；
2. 在进程执行场景中是可以接受中断信号的，而在中断执行场景中是屏蔽中断信号的。所以如果中断执行场景的执行时间太长的话，就会影响我们对新的中断信号的响应性，所以我们需要尽量缩短中断执行场景的时间

**对异步中断的处理有下面两类办法: **
1. 立即完全处理
    对于简单好处理的异步中断可以立即进行完全处理
1. 立即预处理 + 稍后完全处理
    对于处理起来比较耗时的中断可以采取立即预处理加稍后完全处理的方式来处理

立即完全处理和立即预处理都叫做中断预处理，把稍后完全处理叫做中断后处理。中断预处理只有一种实现方式，就是直接处理。但是中断后处理却有很多种方法，其处理方法可以运行在中断执行场景，也可以运行在进程执行场景，前者叫做直接中断后处理，后者叫做线程化中断后处理

在 Linux 中，中断预处理叫做**上半部**，中断后处理叫做**下半部**. **中断预处理**只有一种方法，叫做 <u>hardirq（硬中断）</u>, **中断后处理**有很多种方法，分为两类，直接中断后处理有 <u>softirq (软中断)</u>、<u>tasklet (微任务)</u>，线程化中断后处理有 <u>workqueue (工作队列)</u>、<u>threaded_irq (中断线程)</u>

> [!faq] 硬中断、软中断是什么意思？
> 异步中断处理是直接把中断处理完的，整个过程是屏蔽中断的，现在整个过程被分成了两部分（中断预处理、中断后处理），前半部分还是<u>屏蔽中断</u>的，叫做**硬中断**，处理与硬件相关的紧急事物，后半部分<u>不再屏蔽中断</u>，叫做**软中断**，处理剩余的事物。由于软中断中不再屏蔽中断信号，所以提高了系统对中断的响应性

## 中断向量号
系统依靠<u>中断向量号</u>来区分不同的中断信号。每一个中断信号都有一个中断向量号，中断向量号是一个整数。CPU 收到一个中断信号会根据这个信号的中断的向量号去查询<u>中断向量表</u>，根据向量表里面的指示去调用相应的处理函数

对于 CPU 异常来说，其向量号是由 CPU 架构标准规定的。对于外设来说，其向量号是由设备驱动动态申请的。对于 IPI 中断和指令中断来说，其向量号是由内核规定的

## 中断流程
> CPU 收到中断信号后会首先保存被中断程序的状态，然后再去执行中断处理程序，最后再返回到原程序中被中断的点去执行

### 保存现场
CPU 收到中断信号后会首先把一些数据 push 到内核栈上，保存的数据是和当前执行点相关的，这样中断完成后就可以返回到原执行点

如果 CPU 当前处于用户态，则会先切换到内核态，把用户栈切换为内核栈再去保存数据 (内核栈的位置是在当前线程的 TSS 中获取的)

### 查找向量表





---
# Source
- [硬中断和软中断\_软中断和硬中断\_Coder\_yupeng的博客-CSDN博客](https://blog.csdn.net/weixin_43215305/article/details/120027555)
- [2.6 什么是软中断？ | 小林coding](https://xiaolincoding.com/os/1_hardware/soft_interrupt.html)
---

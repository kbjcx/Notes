---
aliases: [SDS]
area: redis
project: 
date: 2023-07-21 22:28
tags: []
---
---
#### Content
- 用 `sdshdr` 结构体来存储字符串, 定义如下:
```cpp
struct sdshdr {
    int len; // buffer中已使用的长度, 即字符串的长度
    int free; // 剩余的字节大小
    char buf[]; // 存储字符串的字符数组
};
```

> [!attention] 
> `SDS` 的 `buf` 中存储时依然采取了 C 字符串的表示方法, 在字符串末尾添加 `\0` 来表示结束, 这是为了能够兼容部分 C 字符串函数采取的措施. 并且, 插入 `\0` 的过程是透明的, 由内部实现自动添加, 不会占据 `len` 和 `free` 的空间, 因此 `buf` 的实际长度为 `len + free + 1`

![[Pasted image 20230721223407.png]]

##### SDS 相对于 C 字符串的优点
1. 常数复杂度获取字符串长度
2. 杜绝缓冲区溢出
    采用动态分配字符数组长度来杜绝了缓冲区溢出
3. 减少修改字符串时带来的内存重新分配次数
    C 字符串在进行拼接或者截断操作时 , 往往需要进行空间的分配和释放, redis 工作于频繁修改的环境中, 因此采用 SDS 减少字符串修改时的内存重新分配次数
4. 二进制安全
    SDS 通过 `len` 来确定字符串的长度, 因此字符串中间可以存在 `\0`, SDS 的 API 采用处理二进制的方式来处理 `buf` 数组里的数据. C 字符串只能保存文本数据
5. 兼容部分 C 字符串函数

##### 空间预分配
- 如果对 SDS 进行修改之后，SDS 的长度（也即是 `len` 属性的值）将小于 `1MB`，那么程序分配和 `len` 属性同样大小的未使用空间，这时 SDS `len` 属性的值将和 `free` 属性的值相同
- 如果对 SDS 进行修改之后，SDS 的长度将大于等于 `1MB`，那么程序会分配1MB 的未使用空间, 即 SDS 的 `free` 为 `1MB`

##### 惰性空间释放
- 当 SDS 的 API 需要缩短 SDS 保存的字符串时，程序并不立即使用内存重分配来回收缩短后多出来的字节，而是使用 `free` 属性将这些字节的数量记录起来，并等待将来使用

##### API
1.  `sdsnew`: 创建一个新的 SDS 对象。
    描述：该函数用于在堆上分配内存并创建一个空的 SDS 对象。
1. `sdsempty`: 创建一个不包含任何内容的空 SDS
1. `sdsdup`: 创建一个给定的 SDS 的副本
1.  `sdsfree`: 释放 SDS 对象所占用的内存。
    描述：用于释放一个不再需要的 SDS 对象，以避免内存泄漏。
3.  `sdscpy`: 复制一个 SDS 对象。
    描述：将一个 SDS 对象的内容复制到另一个 SDS 对象中。
4.  `sdscat`: 将内容追加到 SDS 对象的末尾。
    描述：用于将一个字符串或另一个 SDS 对象的内容追加到目标 SDS 对象的末尾。
1. `sdscatstd`: 将一个 SDS 追加到 SDS 的末尾
1.  `sdscatprintf`: 格式化字符串并将其追加到 SDS 对象的末尾。
    描述：类似于 C 语言中的 sprintf 函数，但它将格式化的字符串追加到 SDS 对象中。
6.  `sdscmp`: 比较两个 SDS 对象的内容。
    描述：用于比较两个 SDS 对象的内容是否相同，类似于 C 语言中的 `strcmp` 函数。
1.  `sdslen`: 获取 SDS 对象中字符串的长度。
    描述：返回 SDS 对象中保存的字符串的长度，不包括空终止符。
1.  `sdsavail`: 获取 SDS 对象中未使用的空间。
    描述：返回 SDS 对象中未使用的空间大小。
1.  `sdstrim`: 从 SDS 对象的开头和结尾修剪指定的字符。
    描述：用于删除 SDS 对象开头和结尾的指定字符，类似于 C 语言中的 strtrim 函数。
1.  `sdssplitlen`: 将 SDS 对象按照指定的分隔符拆分成多个子 SDS 对象。
    描述：该函数用于将一个 SDS 对象按照指定的分隔符拆分成多个子 SDS 对象，并返回一个子 SDS 对象的数组。
1.  `sdsrange`: 获取 SDS 对象中指定范围的子 SDS 对象。
    描述：用于获取 SDS 对象中指定起始位置和长度的子 SDS 对象。
1.  `sdsmapchars`: 对 SDS 对象中的字符进行替换操作。
    描述：该函数可以用于对 SDS 对象中的字符进行映射操作，类似于 C 语言中的 strmap 函数。
1.  `sdsjoin`: 将多个 SDS 对象连接成一个新的 SDS 对象。
    描述：用于将多个 SDS 对象连接成一个新的 SDS 对象，类似于 C 语言中的 strcat 函数。
1.  `sdssplitargs`: 将一个 C 字符串解析为多个参数的 SDS 对象数组。
    描述：用于将一个 C 字符串解析为多个参数的 SDS 对象数组，常用于解析 Redis 的命令输入。
1.  `sdsupdatelen`: 更新 SDS 对象保存的字符串长度。
    描述：该函数用于更新 SDS 对象的字符串长度，用于手动修改 SDS 对象的长度。

---

---
aliases: []
area: redis
project: 
date: 2023-08-01 10:35
tags: []
---
---
#### Content
Redis 在执行完一条写操作命令后，就会把该命令以追加的方式写入到一个文件里，然后 Redis 重启时，会读取该文件记录的命令，然后逐一执行命令的方式来进行数据恢复
![[Pasted image 20230801103905.png|500]]

> [!question] 为什么先执行命令，再把数据写入日志呢？
> - **避免额外的检查开销**：因为如果先将写操作命令记录到 AOF 日志里，再执行该命令的话，如果当前的命令语法有问题，那么如果不进行命令语法检查，该错误的命令记录到 AOF 日志里后，Redis 在使用日志恢复数据时，就可能会出错。
> - **不会阻塞当前写操作命令的执行**：因为当写操作命令执行成功后，才会将命令记录到 AOF 日志。

> [!caution] 
> - **数据可能会丢失：** 执行写操作命令和记录日志是两个过程，那当 Redis 在还没来得及将命令写入到硬盘时，服务器发生宕机了，这个数据就会有丢失的风险。
> - **可能阻塞其他操作：** 由于写操作命令执行成功后才记录到 AOF 日志，所以不会阻塞当前命令的执行，但因为 AOF 日志也是在主线程中执行，所以当 Redis 把日志文件写入磁盘的时候，还是会阻塞后续的操作无法执行。

##### Redis 写入 AOF 日志的过程
![[Pasted image 20230801104336.png]]

1. Redis 执行完写操作命令后，会将命令追加到 `server. aof_buf` 缓冲区；
1. 然后通过 `write ()` 系统调用，将 `aof_buf` 缓冲区的数据写入到 AOF 文件，此时数据并没有写入到硬盘，而是拷贝到了内核缓冲区 `page cache`，等待内核将数据写入硬盘；
1. 具体内核缓冲区的数据什么时候写入到硬盘，由内核决定。

##### Redis 写回策略
1. **Always：**每次写操作命令执行完后，同步将 AOF 日志数据写回硬盘
2. **Everysec：**每次写操作命令执行完后，先将命令写入到 AOF 文件的内核缓冲区，然后每隔一秒将缓冲区里的内容写回到硬盘
3. **No：**

---

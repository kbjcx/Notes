---
aliases: []
area: redis
project: 
date: 2023-08-01 10:35
tags: []
---
---
#### Content
Redis 在执行完一条写操作命令后，就会把该命令以追加的方式写入到一个文件里，然后 Redis 重启时，会读取该文件记录的命令，然后逐一执行命令的方式来进行数据恢复
![[Pasted image 20230801103905.png|500]]

> [!question] 为什么先执行命令，再把数据写入日志呢？
> - **避免额外的检查开销**：因为如果先将写操作命令记录到 AOF 日志里，再执行该命令的话，如果当前的命令语法有问题，那么如果不进行命令语法检查，该错误的命令记录到 AOF 日志里后，Redis 在使用日志恢复数据时，就可能会出错。
> - **不会阻塞当前写操作命令的执行**：因为当写操作命令执行成功后，才会将命令记录到 AOF 日志。

> [!caution] 
> - **数据可能会丢失：** 执行写操作命令和记录日志是两个过程，那当 Redis 在还没来得及将命令写入到硬盘时，服务器发生宕机了，这个数据就会有丢失的风险。
> - **可能阻塞其他操作：** 由于写操作命令执行成功后才记录到 AOF 日志，所以不会阻塞当前命令的执行，但因为 AOF 日志也是在主线程中执行，所以当 Redis 把日志文件写入磁盘的时候，还是会阻塞后续的操作无法执行。

##### Redis 写入 AOF 日志的过程
![[Pasted image 20230801104336.png]]

1. Redis 执行完写操作命令后，会将命令追加到 `server. aof_buf` 缓冲区；
1. 然后通过 `write ()` 系统调用，将 `aof_buf` 缓冲区的数据写入到 AOF 文件，此时数据并没有写入到硬盘，而是拷贝到了内核缓冲区 `page cache`，等待内核将数据写入硬盘；
1. 具体内核缓冲区的数据什么时候写入到硬盘，由内核决定。

##### Redis 写回策略
1. **Always:** 每次写操作命令执行完后，同步将 AOF 日志数据写回硬盘
2. **Everysec:** 每次写操作命令执行完后，先将命令写入到 AOF 文件的内核缓冲区，然后每隔一秒将缓冲区里的内容写回到硬盘
3. **No:** 不由 Redis 控制写回硬盘的时机，转交给操作系统控制写回的时机，也就是每次写操作命令执行完后，先将命令写入到 AOF 文件的内核缓冲区，再由操作系统决定何时将缓冲区内容写回硬盘

![[Pasted image 20230801104610.png]]

> [!question] AOF 日志过大，会触发什么机制？
> AOF 日志是一个文件，随着执行的写操作命令越来越多，文件的大小会越来越大。
> 如果当 AOF 日志文件过大就会带来性能问题，比如重启 Redis 后，需要读 AOF 文件的内容以恢复数据，如果文件过大，整个恢复的过程就会很慢。
> 所以，Redis 为了避免 AOF 文件越写越大，提供了 **AOF 重写机制**，当 AOF 文件的大小超过所设定的阈值后，Redis 就会启用 AOF 重写机制，来压缩 AOF 文件

##### AOF 重写机制
- ***AOF 重写机制*** 是在重写时，读取当前数据库中的所有键值对，然后将每一个键值对用一条命令记录到「新的 AOF 文件」，等到全部记录完后，就将新的 AOF 文件替换掉现有的 AOF 文件

> [!question] 重写 AOF 日志的过程是怎样的？
> 1. Redis 的重写 AOF 过程是由后台子进程 `bgrewriteaof` 来完成的，因此重写过程中，主进程依然可以正常处理命令
> 1. 为了解决重写过程中主进程修改了 key-value 数据不一致问题，Redis 设置了一个 **AOF 重写缓冲区**，这个缓冲区在创建 `bgrewriteaof` 子进程之后开始使用
> 1. 在重写 AOF 期间，当 Redis 执行完一个写命令之后，它会同时将这个写命令写入到 **「AOF 缓冲区」** 和 **「AOF 重写缓冲区」**
> 1. 当子进程完成 AOF 重写工作（扫描数据库中所有数据，逐一把内存数据的键值对转换成一条命令，再将命令记录到重写日志）后，会向主进程发送一条信号，信号是进程间通讯的一种方式，且是异步的
> 1. 主进程收到该信号后，会调用一个信号处理函数，将 AOF 重写缓冲区中的所有内容追加到新的 AOF 的文件中，使得新旧两个 AOF 文件所保存的数据库状态一致，新的 AOF 的文件进行改名，覆盖现有的 AOF 文件

##### 优点
1. 丢失数据少，根据写回策略不同丢失数据也不一样，**Always** 可能丢失一条数据，**Everysec** 可能丢失 1 秒内的数据，**No** 可能丢失内核缓冲区还未写回磁盘的数据
##### 缺点
1. 进行恢复时需要将所有的命令都执行一遍，会导致 Redis 恢复操作缓慢


---

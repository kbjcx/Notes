---
aliases: [raft]
area: 分布式
project: 
date: 2023-08-07 08:55
tags: []
---
---
#### Content
Raft 所运行的系统模型：
1. 服务器可能宕机、停止运行，过段时间再恢复。但不存在拜占庭故障，即节点的行为是非恶意的，不会篡改数据
2. 消息有可能丢失、延迟、乱序和重复。可能有网络分区，但会在一段时间后恢复

> [!tip] Raft 和 Multi-paxos 一样是基于领导者（leader）的共识算法，主要分两种情况讨论算法流程
> 1. 领导者正常运行
> 2. 领导者故障，必须选出新的领导者接管和推进算法

Raft 算法中的服务器在任意时间只能属于下列三种状态之一：
1. 领导者（Leader）
    负责处理客户端请求和日志复制，同一时刻只能有一个正常工作的领导者
1. 跟随者（Follower）
    完全被动的处理请求，不主动发送 RPC 请求，只响应收到的 RPC 请求
1. 候选者（Candidate）
    用来选举出新的领导者，是处于领导者和跟随者之间的一种状态

Raft 选举出新的领导者意味着算法进入了新的任期（Term），任期通常分为两部分，任期开始时的选举过程和算法正常运行过程。
![[Pasted image 20230807090727.png]]

有时候一个任期内没有选举出领导者，此时会直接进入下一个任期，重新尝试选举出一个领导者

节点之间通过任期号来判断消息是否是最新的

#### 领导者选举
领导者会向跟随者定时发送心跳包来确认自己的领导地位，如果跟随者在**选举超时时间**内没有收到任何任期更大的 RPC 请求，则该节点就会认为集群中没有领导者，就会开启新一轮选举。

> [!faq] 节点选举流程
>     1. 将自己转化为候选者
>     2. 增加自己的当前任期变量 `currentTerm`，表示一个新的任期
>     3. 先给自己投一票
>     4. 向系统的其他节点发送消息索要选票
>     5. 在此期间，如果收到了多数派的选票，则晋升为领导者，或者收到了来自更大任期的领导者的 RPC 请求，则重新成为跟随者，否则在超过选举超时时间后重新开启一轮选举

![[Pasted image 20230807094504.png]]

选举过程中需要保证共识算法的两个特性：**安全性和活性**
**安全性**是指一个任期内只能选举出一个领导者，要做到安全性需要保证：
1. 同一个节点在同一个任期内只能给一个节点投票，并且需要把投票信息持久化，以免宕机之后造成重复投票
2. 只有获得多数派（超过半数节点）的选票才能成为领导者

**活性**是指要确保系统能够选举出一个领导者，需要避免候选者在同一时间索要选票，导致选票被瓜分，无法达成多数派的要求，因此需要给节点**随机选择超时时间**，让节点不在同时索要选票

#### 日志复制
Raft 的日志条目包含以下内容：
1. **索引**：表示该条目在整个日志中的位置
2. **任期号**：日志条目首次被领导者创建的任期
3. **命令**：应用于状态机的命令




---

---
aliases: []
area: 分布式
project: 
date: 2023-08-08 14:27
tags: []
---
---
#### Content
事务必须遵从四个属性 **ACID**：
- **原子性（Atomicity）：** 一个事务包含的所有操作，要么全部完成，要么全部不完成，不会在中间某个环节结束，即使事务在执行过程中发生错误，也会被回滚 Rollback 到事务开始前的状态，就像这个事务从来没有执行过一样，即事务中的操作不可分割
- **一致性（Consistency）：** 在事务开始之前和事务结束以后，数据库的完整性没有被破坏。事务必须保证数据库可以从一个一致的状态转移到另一个一致的状态，这种一致性要求不仅指常见的数据库完整性约束（例如主键、外键、触发器、 check 等约束），有时还需要由用户（应用程序）来保证，例如用户指定数据库字段必须满足 $A+B=100$，如何保证该约束是用户层编写事务的程序员的职责
- **隔离性（Isolation）：** 数据库允许多个并发事务同时对其数据进行读写和修改，隔离性可以防止在多个事务并发执行时，由于交叉执行而导致数据出现异常的情况。不同的隔离级别有着不同的保证
- **持久性（Durability）：** 事务结束后，对数据的修改就是永久的，即便系统出现故障也不会丢失数据。在实际项目中，这意味着数据库会将数据写入非易失性存储设备，如磁盘或 SSD

> [!attention] 
> ACID 中的一致性和 CAP 定理中的一致性是不一样的，ACID 中的 C 属于数据库事务；领域的概念，指在事务开始之前和事务结束以后，数据库的完整性没有被破坏；而 CAP 定理中的 C 指的是线性一致性

**分布式事务**一般是单机事务的两种变体：
1. **第一种变体：** 同一份数据需要在多个副本上更新，一个分布式事务需要更新所有的副本，不能有一个副本提交了，而另一个副本回滚了
2. **第二种变体：** 数据进行了分区，一个事务需要跨节点保证数据的一致性

#### 原子提交
分布式事务的原子性通过原子提交协议（Atomic Commit Protocol，ACP）来实现，原子提交协议（算法）必须满足以下三个特性：
1. **协定性（Agreement）** 所有进程都决议出一个值，相当于所有进程要么一起提交事务，要么一起终止事务，不存在一个提交事务一个终止事务的情况
2. **有效性（Validity）** 如果所有进程都决定提交事务并且没有任何故障发生，那么最终整个系统将提交事务；只要有一个进程终止事务，系统将终止事务
3. **终止性（Termination）** *弱终止条件：* 所有如果没有任何故障发生，那么所有进程最终都会最初决议（提交或终止事务）；*强终止条件：* 也称为*非阻塞条件*，指没有发生故障的进程最终会做出决议

##### 两阶段提交
**两阶段提交的基本思想**是既然仅仅发送一个请求不足以知道其他节点能否成功提交事务，最直接的想法就是再增加一轮请求，先检查每个节点上的状态是否能够满足事务正确性，在进行事务操作

两阶段提交包含两个角色：**协调者** 和 **参与者**，协调者负责协调算法的各个阶段，而参与者则参与到事务中执行事务操作，可以选择其中一个参与者来同时扮演协调者

两阶段提交的过程：
**一阶段被称为准备阶段或是投票阶段**
1. 协调者向参与者并行发送消息，询问参与者是否可以提交事务，并等待参与者响应
2. 参与者



---

---
aliases: []
area: redis
project: 
date: 2023-08-03 20:38
tags: []
---
---
#### Content
在 Redis 的主从架构中，由于主从模式是读写分离的，如果主节点（master）挂了，那么将没有主节点来服务客户端的写操作请求，也没有主节点给从节点（slave）进行数据同步了

这时如果要恢复服务的话，需要人工介入，选择一个「从节点」切换为「主节点」，然后让其他从节点指向新的主节点，同时还需要通知上游那些连接 Redis 主节点的客户端，将其配置中的主节点 IP 地址更新为「新主节点」的 IP 地址

Redis 在 2.8 版本以后提供的**哨兵（Sentinel）机制**，它的作用是实现**主从节点故障转移**。它会监测主节点是否存活，如果发现主节点挂了，它就会选举一个从节点切换为主节点，并且把新主节点的相关信息通知给从节点和客户端

#### 哨兵机制是如何工作的？
哨兵其实是一个运行在特殊模式下的 Redis 进程，所以它也是一个节点。从“哨兵”这个名字也可以看得出来，它相当于是“观察者节点”，观察的对象是主从节点

> [!info] 
> 哨兵节点主要负责三件事情：**监控**、**选主**、**通知**

##### 如何判断主节点真的故障了？
哨兵会每隔 1 秒给所有主从节点发送 PING 命令，当主从节点收到 PING 命令后，会发送一个响应命令给哨兵，这样就可以判断它们是否在正常运行
![[Pasted image 20230803204458.png]]

如果主节点或者从节点没有在规定的时间内响应哨兵的 PING 命令，哨兵就会将它们标记为**「主观下线」** 。这个「规定的时间」是配置项 `down-after-milliseconds` 参数设定的，单位是毫秒

之所以针对「主节点」设计「主观下线」和「客观下线」两个状态，是因为有可能「主节点」其实并没有故障，可能只是因为主节点的系统压力比较大或者网络发送了拥塞，导致主节点没有在规定时间内响应哨兵的 PING 命令

> [!tip]
> 为了减少误判的情况，哨兵在部署的时候不会只部署一个节点，而是用多个节点部署成**哨兵集群**（最少需要三台机器来部署哨兵集群），**通过多个哨兵节点一起判断，就可以就可以避免单个哨兵因为自身网络状况不好，而误判主节点下线的情况**。同时，多个哨兵的网络同时不稳定的概率较小，由它们一起做决策，误判率也能降低

当一个哨兵判断主节点为「主观下线」后，就会向其他哨兵发起命令，其他哨兵收到这个命令后，就会根据自身和主节点的网络状况，做出赞成投票或者拒绝投票的响应
![[Pasted image 20230803204839.png]]

当这个哨兵的赞同票数达到哨兵配置文件中的 quorum 配置项设定的值后，这时主节点就会被该哨兵标记为「客观下线」

> [!tip] 
> quorum 的值一般设置为哨兵个数的二分之一加 1

##### 由哪个哨兵进行主从故障转移？
> [!tip] 
> 哨兵是以哨兵集群的方式存在的

哪个哨兵节点判断主节点为「客观下线」，这个哨兵节点就是候选者，候选者会向其他哨兵发送命令，表明希望成为 Leader 来执行主从切换，并让所有其他哨兵对它进行投票。每个哨兵只有一次投票机会，如果用完后就不能参与投票了，可以投给自己或投给别人，但是只有候选者才能把票投给自己。

在投票过程中，任何一个「候选者」，要满足两个条件：
1. 拿到半数以上的赞成票
2. 拿到的票数同时还需要大于等于哨兵配置文件中的 quorum 值

> [!faq] 假设有多个哨兵同时判断主节点「主观下线」，该怎么选取哨兵 leader？
> 此时每个候选者会给自己投一票，然后向其他哨兵发起投票请求，投票者会依次为候选者投票，但是如果已经投出票后会拒绝后续的投票请求

> [!faq] 为什么哨兵节点至少要有 3 个？
> 为了保证哨兵节点挂掉 1 个之后依然可以判断主节点下线进行主从切换操作

> [!faq] 为什么哨兵节点数量推荐是奇数？
> 1. 减少出现同票的情况
> 2. 奇数节点相比于偶数节点，在相同的选主票数情况下，比偶数节点多一个节点的容忍度

##### 主从故障转移的过程是怎样的？
主从故障转移操作包含以下**四个步骤**：
###### 选举出新节点
首先要把网络状态不好的从节点给过滤掉。首先把已经下线的从节点过滤掉，然后把以往网络连接状态不好的从节点也给过滤掉

> [!faq] 怎么判断从节点之前的网络连接状态不好呢？
> Redis 有个叫 down-after-milliseconds * 10 配置项，其 down-after-milliseconds 是主从节点断连的最大连接超时时间。如果在 down-after-milliseconds 毫秒内，主从节点都没有通过网络联系上，我们就可以认为主从节点断连了。如果**发生断连的次数超过了 10 次**，就说明这个从节点的网络状况不好，不适合作为新主节点

接下来要对所有从节点进行三轮考察：**优先级**、**复制进度**、**ID 号**

**第一轮考察：优先级最高的从节点胜出**
Redis 有个叫 slave-priority 配置项，可以给从节点设置优先级，每一台从节点的服务器配置不一定是相同的，我们可以根据服务器性能配置来设置从节点的优先级

**第二轮考察：复制进度最靠前的从节点胜出**
如果在第一轮考察中，发现优先级最高的从节点有两个，那么就会进行第二轮考察，比较两个从节点哪个复制进度

> [!faq] 什么是复制进度？
> 主从架构中，主节点会将写操作同步给从节点，在这个过程中，主节点会用 master_repl_offset 记录当前的最新写操作在 repl_backlog_buffer 中的位置（如下图中的「主服务器已经写入的数据」的位置），而从节点会用 slave_repl_offset 这个值记录当前的复制进度（如下图中的「从服务器要读的位置」的位置）

如果某个从节点的 slave_repl_offset 最接近 master_repl_offset，说明它的复制进度是最靠前的，于是就可以将它选为新主节点

**第三轮考察：ID 号小的从节点胜出**
如果在第二轮考察中，发现有两个从节点优先级和复制进度都是一样的，那么就会进行第三轮考察，比较两个从节点的 ID 号，**ID 号小的从节点胜出**

> [!note] 个人猜测
> ID 号小的节点建立的时间更长，说明该节点的可靠性相对更高

可以通过向「从节点」发送 **SLAVEOF no one** 命令来实现转化为主节点，哨兵 leader 会以每秒一次的频率向被升级的从节点**发送 INFO 命令**（没进行故障转移之前，INFO 命令的频率是每十秒一次），并观察命令回复中的角色信息，当被升级节点的角色信息从原来的 slave 变为 master 时，哨兵 leader 就知道被选中的从节点已经顺利升级为主节点了

###### 将从节点指向新主节点
当新主节点出现之后，哨兵 leader 下一步要做的就是，让已下线主节点属下的所有「从节点」指向「新主节点」，这一动作可以通过向「从节点」发送 **SLAVEOF** 命令来实现

###### 通知客户的主节点已更换
通过 Redis 的**发布者/订阅者机制**来实现的。每个哨兵节点提供发布者/订阅者机制，客户端可以从哨兵订阅消息

主从切换完成后，哨兵就会向` +switch-master `频道发布新主节点的 IP 地址和端口的消息，这个时候客户端就可以收到这条信息，然后用这里面的新主节点的 IP 地址和端口进行通信了

###### 将旧主节点变为从节点
故障转移操作最后要做的是，继续监视旧主节点，当旧主节点重新上线时，哨兵集群就会向它发送 **SLAVEOF** 命令，让它成为新主节点的从节点

---

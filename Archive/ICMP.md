---
aliases: [互联网控制报文协议]
area: 计算机网络
project: 
date: 2023-06-16 11:46
tags: []
---
---
#### Description
- ICMP 主要的功能包括：**<font color="#0593A2">确认 IP 包是否成功送达目标地址、报告发送过程中 IP 包被废弃的原因和改善网络设置等</font>** 
- 在 IP 通信中如果某个 IP 包因为某种原因未能达到目标地址，那么这个具体的原因将由 ICMP 负责通知

ICMP 大致可以分为两大类：
- 一类是用于诊断的查询消息，也就是「查询报文类型」
- 另一类是通知出错原因的错误消息，也就是「差错报文类型」

![[Pasted image 20230616115453.png]]

##### ICMP 包头格式
- ICMP 报文是封装在 IP 包里面，它工作在网络层，是 IP 协议的助手

![[Pasted image 20230616120647.png]]
###### 查询报文
> [!note] 回送消息 —— 类型 0 和 8

- 回送消息用于进行通信的主机或路由器之间，判断所发送的数据包是否已经成功到达对端的一种消息，ping 命令就是利用这个消息实现的
- 可以向对端主机发送**回送请求**的消息（ICMP Echo Request Message，类型 8），也可以接收对端主机发回来的**回送应答**消息（ICMP Echo Reply Message，类型 0）
- 相比于原生的 ICMP 报文, Ping 增加了两个字段来实现功能:
    ![[Pasted image 20230616145856.png]]
    1. **标识符**:  用以区分是哪个应用程序发 ICMP 包，比如用进程 PID 作为标识符
    2. **序列号**: 序列号从 0 开始，每发送一次新的回送请求就会加 1，可以用来确认网络包是否有丢失
    3. 在**选项数据**中，ping 还会存放发送请求的时间值，来计算往返时间，说明路程的长短
###### 差错报文
1. 目标不可达
    - IP 路由器无法将 IP 数据包发送给目标地址时，会给发送端主机返回一个目标不可达的 ICMP 消息，并在这个消息中显示不可达的具体原因，原因记录在 ICMP 包头的代码字段
    ![[Pasted image 20230616150335.png|500]]
2. 原点抑制消息
    在使用低速广域线路的情况下，连接 WAN 的路由器可能会遇到网络拥堵的问题. ICMP 原点抑制消息的目的就是为了缓和这种拥堵情况. **这种 ICMP 可能会引起不公平的网络通信，一般不被使用**
3. 重定向消息
    如果路由器发现发送端主机使用了「不是最优」的路径发送数据，那么它会返回一个 ICMP 重定向消息给这个主机, 消息中包含了最合适的路由信息和源数据
4. 超时消息
    IP 包中有一个字段叫做 TTL （Time To Live，生存周期），它的值随着每经过一次路由器就会减 1，直到减到 0 时该 IP 包会被丢弃。此时，路由器将会发送一个 ICMP 超时消息给发送端主机，并通知该包已被丢弃



---
#### Source

---
aliases: [回收内存]
area: 操作系统
project: 
date: 2023-04-12 16:04
---
---
#### Description
##### 内存回收的方式
1. **后台内存回收 (kswapd)**
    在物理内存紧张的时候, 会唤醒 `kswapd` 内核线程来回收内存, 这个回收内存的过程是**<font color="#0593A2">异步</font>**的, 不会阻塞进程的执行
2. **直接内存回收**
    如果后台异步回收跟不上进程内存申请的速度, 就会开始直接回收, 这个回收过程是**<font color="#0593A2">同步</font>**的, 会阻塞进程的执行

> [!note] 
> 如果直接内存回收后, 空闲的物理内存仍然不满足物理内存的申请, 那么内核就会触发<font color="#0593A2"> [[OOM]] (Out of Memory)机制</font>

![[Pasted image 20230412163918.png|600]]

##### 哪些内存可以被回收 ?
主要有两类内存可以被回收: 
1. **文件页 (File-backed Page)**
    内核缓存的磁盘数据 (Buffer) 和内核缓存的文件数据 (Cache) 都叫作文件页
    文件页又分为「干净页」(没有被修改过的文件)和「脏页」(被程序修改过的还没写入磁盘的数据), 回收干净页时直接释放内存, 回收脏页时先写回磁盘再释放内存
2. **匿名页 (Anonymous Page)**
    这部分内存没有实际载体，不像文件缓存有硬盘文件这样一个载体，比如堆、栈数据等。这部分内存很可能还要再次被访问，所以不能直接释放内存，它们回收的方式是通过 Linux 的 Swap 机制 ([[内存交换]])，Swap 会把不常访问的内存先写到磁盘中，然后释放这些内存，给其他更需要的进程使用。再次访问这些内存时，重新从磁盘读入内存就可以了.

- 文件页和匿名页的回收都通过 [[最近最少使用算法|LRU]] 算法

- **内存回收带来的性能损耗**
    - 后台内存回收方式是异步回收的, 不会阻塞进程, 但是直接内存回收方式是同步回收的, 会阻塞当前的进程
    - 文件页回收时, 对于干净页而言是直接回收内存, 这个操作不会影响系统性能, 但是在回收脏页的时候会将内存的数据写回到磁盘, 因此会产生磁盘 IO 带来的性能损耗
    - 匿名页回收时总是会产生磁盘 IO, 会将不常用的匿名页 Swap 到磁盘上, 等到下次访问它时再从磁盘加载到内存中

- 操作系统内核定义了三个阈值: **<font color="#0593A2">页高阈值</font>**, **<font color="#0593A2">页低阈值</font>**和**<font color="#0593A2">最小阈值</font>**
![[Pasted image 20230412182246.png]]
kswapd 会定期扫描内存的使用情况，根据剩余内存（pages_free）的情况来进行内存回收的工作
- 如果剩余内存大于「页高阈值」, 则表示剩余内存充足, 不必回收内存
- 如果剩余内存在「页低阈值」和「页高阈值」之间, 说明内存有一定的压力, 但还能满足进程内存分配的需求
- 如果剩余内存在「最小阈值」和「页低阈值」之间, 说明内存压力较大, 这时会执行后台内存回收, 直到剩余内存大于「页高阈值」为止
- 如果剩余内存小于「最小阈值」, 说明内存已经基本耗尽, 后台内存回收方式无法满足内存分配的需求, 因此会触发直接内存回收方式
---
#### Source
- [4.3 内存满了，会发生什么？ | 小林coding](https://xiaolincoding.com/os/3_memory/mem_reclaim.html#%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E7%9A%84%E8%BF%87%E7%A8%8B%E6%98%AF%E6%80%8E%E6%A0%B7%E7%9A%84)
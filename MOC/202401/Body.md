# Introduction
&emsp;&emsp;锂离子电池具有能量比高、循环寿命长和自放电率低等特点，在电动汽车能源供应方面得到了广泛应用。但是随着锂离子电池的老化，锂离子电池内阻增加，导致电池电解液泄露、短路甚至是热失控等问题。能量管理系统能够通过核电状态（State of Charge，SOC）与健康状态（State of Health，SOH）来确保锂电池状态处于安全工作的范围内。因此有必要在锂电池充放电循环中对 SOC 和 SOH 进行准确的估计，为下一步指定运维计划提供依据。其中，SOC 是指一定放电倍率下当前剩余容量与额定容量的比值【1】，用来量化当前电池所剩余的能量；而 SOH 一般定义为衰减后的容量与标称容量的比值。【2,3】

&emsp;&emsp;目前针对 SOC 与 SOH 估计的研究较多，主流研究可以分为基于模型和数据驱动两大类。

&emsp;&emsp;基于模型的方法通常采用电池等效电路模型（Equivalent Circuit Model，ECM）或电化学模型（Electrochemical Model，EM）的方法。Yu 等人[12]提出了一种基于局部线性化的线性卡尔曼滤波（Linear Kalman Filter，LKF）方法用于锂离子电池的 SOC 估计。为了解决预测过程中的测量噪声和观测噪声问题，Xiong 等人[14]使用了自适应扩展卡尔曼滤波（Adaptive Extended Kalman Filter，AEKF）方法结合 OCV-SOC 表建立了在线 SOC 估计，有效避免了算法的发散和偏差。Tang 等人[47]为了应对非受控环境中的老化波动，提出了一种基于模型的梯度校正粒子滤波方法来预测锂离子电池的老化过程。Miao 等人[48]使用 UPF 来估计电池的容量衰减，结果误差在 5%以内。

&emsp;&emsp;Tian 等人[29]针对 LiFePO4电池在 SOC 中间范围内的平坦开路电压特性，提出了一种基于深度神经网络（Deep Neural Network，DNN）的 SOC 估计方法。[赵赛超](https://www.sciencedirect.com/science/article/pii/S2352152X22009082)将广义学习系统（BLS）算法与长短期记忆神经网络（LSTM NN）相结合，建立了融合神经网络模型，对锂离子电池容量和 RUL 进行了出色的预测。Zhao 等人[63]为了减少计算资源，将宽度学习系统（Broad Learning System，BLS）和长短期记忆网络（LSTM）相结合，开发了一种融合神经网络模型。Ma 等人[61]首先利用皮尔逊相关系数选择了与电池容量相关性更高的特征，然后提出了一种利用差分进化灰狼优化器进行超参数选择的改进 LSTM 模型。

&emsp;&emsp;综上所述，锂离子电池的 SOC 与 SOH 估计方法已经比较成熟，但大多是对 SOC 与 SOH 单独进行估计，而忽略了 SOC 与 SOH 之间的联系。因此将 SOC 与 SOH 进行联合估计的研究是必要的。[张欣](https://webofscience.clarivate.cn/wos/alldb/full-record/WOS:000909216300001)等提出了一种基于 GWO-BP 神经网络的 SOH-SOC 联合估计模型，利用 SOH 来修正 Ah 积分方法。但是安时积分的准确度很大程度上受初始 SOC 的准确性以及累积误差的影响。[蒋波](https://www.sciencedirect.com/science/article/pii/S0306261919312930)等提出了一种基于自适应变量多时间尺度框架的电池 SOC 和容量联合估计方法，基于自适应扩展卡尔曼滤波器自适应更新噪声协方差来提高估计的准确性。但是基于模型的方法泛化能力较差。[胡盼盼](https://www.mdpi.com/1996-1073/16/14/5313)等提出了一种基于非线性状态空间重构(NSSR)和长短期记忆(LSTM)神经网络的 SOC 和 SOH 联合估计方法。[安佳坤](https://www.mdpi.com/1996-1073/16/10/4243)等建立了一种利用 PSO 算法优化 XGBoost 算法的 SOC 与 SOH 联合预测模型。上述研究往往将 SOC 与 SOH 同时作为预测模型的输出，但是 SOH 与 SOC 的输入参数尺度是不一样的。SOH 需要的是多个充放电循环的特征，且预测频率低。而 SOC 需要的是单个充放电循环内的特征，且预测频率高。将 SOC 与 SOH 放到统一尺度考虑不仅会因特征量的减少降低 SOH 的预测精度，也会因为频繁地预测带来较大的计算负荷。

&emsp;&emsp;因此，本文提出了一种两阶段的 SOH 与 SOC 联合估计方法。采用 Encoder-Decoder 模型结合扩张卷积，基于数据驱动的方法进行 SOC 与 SOH 的联合估计。第一阶段是基于多循环数据的 SOH 估计，第二阶段将 SOH 引入模型进行基于单循环数据的 SOC 估计。并且模型基于 Encoder-Decoder 结构能够根据 SOC 与 SOH 的不同需求实现灵活的编码和解码调整。最后根据 Oxford 电池老化数据集，以电压、电流、表面温度为特征对 SOC 与 SOH 进行联合，对比验证了本文所提方法的有效性和准确性。

# Method
## 编解码模型
SOH 需要的是整个充放电循环的数据，而 SOC 需要的是充放电过程中固定的步长信息，这就导致了输入并不相同，因此在模型中处理不同的输入至关重要。编解码模型是一种在人工智能领域广泛应用的方法。它主要由两个部分组成：编码器和解码器。编码器负责将输入数据转换为一种有意义的表示形式，通常是一个向量或矩阵；而解码器则负责将这种表示形式转换为输出数据。

 #TODO 图片
 
在使用编解码模型时，首先通过编码器将输入数据编码成一个隐藏表示，然后解码器将隐藏表示解码为输出数据。这种模型能够将输入与输出划分为两个阶段，我们可以采用不同的编码器对数据进行编码，采用相同的解码器进行解码。同时也能够在 SOC 解码阶段进行 SOH 特征融合。

## 因果扩张卷积
LSTM 常被用于时间序列预测问题，但是 LSTM 预测过程中后续结果依赖于前面的预测结果，因此会导致误差累计，在预测后期造成较大的偏离。并且两个电池之间的 SOH 变化曲线并不完全相同，这就导致 LSTM 在两个序列之间的泛化性能会降低。而 CNN 作为一种优秀的网络结构设计，能够通过提取特征的方式来拟合结果。相比于 LSTM 学习曲线的变化趋势而言，CNN 学习的是电池充放电参数与 SOH、SOC 之间的非线性拟合关系。不仅泛化能力更强，并且模型所需的参数量也远远小于 LSTM。对于充放电曲线而言，先后数据之间存在着明显的依赖关系，但是进行卷积核运算时，卷积中心的数据能够获取到的是该点之前与之后的数据。导致在模型拟合过程中前置的数据引用了后置的数据，这是不合理的。因此采用卷积截断的方式来切断当前数据与后续数据之间的关联，保持前后数据之间的依赖关系，这就是因果卷积。网络结构如下图所示：
#TODO 因果卷积图
从网络结构中可以看出，因果卷积对历史信息的覆盖范围不大。明显增加模型的深度能够增加卷积的覆盖范围，但是随着模型深度的增加会导致计算量过大、模型过拟合等问题。因此，在因果卷积中加入空洞来增大卷积核的感受野。如下图所示：
#TODO 因果扩张卷积图
从图中可以看到，每增加一层，扩张因子就会以 2 的幂次的方式增长，这样能够迅速增加模型的感受野从而保持较低的模型深度。
## HuberLoss 
序列数据常用的损失函数为 MSE 与 MAE。MSE 能够在损失较小时能够得到更小的梯度，因此能够在训练中得到更精确的模型，但是它在损失较大时会放大误差从而给某些异常值更大的权重，导致模型收异常点的影响。而 MAE 全程保持相同的梯度，在误差较小时不利于模型进一步收敛，但是同时 MAE 对异常点的敏感度更小，鲁棒性更高。因此两种损失函数各具优缺点，因此 HuberLoss 将两者进行结合，表达式如下：
$$
\begin{equation}
L_{\delta}=\left\{
\begin{array}{rcl}
&\frac{1}{2} \left(y-f(x)\right)^2 & {|y - f(x)| \le \delta}\\
&\delta * |y-f(x)|-\frac{1}{2} \delta^{2} & {|y-f(x)| > \delta}\\
\end{array} \right.
\end{equation}
$$
其中 $\delta$ 为 HuberLoss 的超参数,当 $\delta$ 趋近于 0 时，Huber 趋近于 MAE，反之当 $\delta$ 趋近于 $+\infty$, HuberLoss 趋近于 MSE。HuberLoss 不仅增强了模型对于离群点的鲁棒性，并且弥补了 MAE 在损失较小时难以收敛的问题。
## 联合估计模型 
本文提出了一种基于编解码器的 SOH 与 SOC 联合估计模型，该模型由三部分组成：SOH 编码器、SOC 编码器与解码器。该模型能够将 SOH 编码特征与 SOC 编码特征进行融合，从而利用充放电循环的 SOH 特征来修正 SOC 预测的结果。这使得 SOC 预测能够在容量衰减的过程中保持对当前 SOH 的感知，从而提高 SOC 的估计精度。并且该模型将 SOH 与 SOC 分为两阶段编码，能够使用不同的输入参数。SOH 编码采用整个充放电循环的采样点而 SOC 编码采用充放电循环中的固定步长的采样点。这样能够使得 SOH 编码与 SOC 编码关注不同尺度的充放电特征，使得 SOH 获取到长时间的完整的充放电循环特征，而 SOC 获取到短时间内的充放电特征。这避免了传统 SOC 与 SOH 联合估计时输入采样长度与模型实时性之间的矛盾。同时，该模型在时间尺度上也对 SOH 与 SOC 预测进行了分离，在单个充放电循环内使用的是相同的 SOH 编码特征，这与传统的 SOH 与 SOC 联合估计相比避免了短时间内对 SOH 的频繁预测，大大减少了模型的计算量。模型各部分说明如下：
### 编码器
### 解码器
